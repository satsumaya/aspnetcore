<Project>

  <Target Name="_ComputeServiceWorkerAssetsManifestInputs"
          Condition="'$(ServiceWorkerAssetsManifest)' != ''"
          BeforeTargets="_ResolveBlazorOutputs">

    <PropertyGroup>
      <_ServiceWorkerAssetsManifestIntermediateOutputPath>$(_BlazorIntermediateOutputPath)serviceworkerassets.js</_ServiceWorkerAssetsManifestIntermediateOutputPath>
    </PropertyGroup>

    <ItemGroup>
      <_BlazorOutputWithTargetPath Condition="'$(ServiceWorkerAssetsManifest)' != ''"
        Include="$(_ServiceWorkerAssetsManifestIntermediateOutputPath)"
        TargetOutputPath="$(_BaseBlazorDistPath)$(ServiceWorkerAssetsManifest)" />
    </ItemGroup>

  </Target>

  <UsingTask TaskName="GenerateServiceWorkerAssetsManifest" AssemblyFile="$(_BlazorTasksPath)" />

  <Target Name="_WriteServiceWorkerAssetsManifest"
          Condition="'$(ServiceWorkerAssetsManifest)' != ''"
          Inputs="@(ServiceWorkerAssetsManifestItem)"
          Outputs="$(_ServiceWorkerAssetsManifestIntermediateOutputPath)"
          BeforeTargets="_BlazorStaticWebAssetsCopyGeneratedFilesToOutputDirectory"
          DependsOnTargets="_ComputeServiceWorkerAssetsManifestFileHashes; _ComputeDefaultServiceWorkerAssetsManifestVersion">

    <GenerateServiceWorkerAssetsManifest
      Version="$(ServiceWorkerAssetsManifestVersion)"
      AssetsWithHashes="@(_ServiceWorkerAssetsManifestItemWithHash)"
      OutputPath="$(_ServiceWorkerAssetsManifestIntermediateOutputPath)" />

    <ItemGroup>
      <FileWrites Include="$(_ServiceWorkerAssetsManifestIntermediateOutputPath)" />
    </ItemGroup>

  </Target>

  <Target Name="_ComputeServiceWorkerAssetsManifestFileHashes">

    <ItemGroup>
      <ServiceWorkerAssetsManifestItem
        Include="%(StaticWebAsset.Identity)"
        Condition="'%(RelativePath)' != '$(ServiceWorkerAssetsManifest)'">
        <AssetUrl>$([System.String]::Copy('$([System.String]::Copy('%(StaticWebAsset.BasePath)').TrimEnd('/'))/%(StaticWebAsset.RelativePath)').Replace('\','/').TrimStart('/'))</AssetUrl>
      </ServiceWorkerAssetsManifestItem>

      <!-- Don't include compressed files in the manifest, since their existence is transparent to the client -->
      <ServiceWorkerAssetsManifestItem Remove="@(_CompressedStaticWebAsset->'%(FullPath)')" />

      <!-- Don't include the service worker files in the manifest, as the service worker doesn't need to fetch itself -->
      <_ServiceWorkerSourcesToRemove Include="@(_ServiceWorkerSource->'%(IntermediatePath)')" />
      <ServiceWorkerAssetsManifestItem Remove="@(_ServiceWorkerSourcesToRemove->'%(FullPath)')" />
    </ItemGroup>

    <GetFileHash Files="@(ServiceWorkerAssetsManifestItem)" Algorithm="SHA256" HashEncoding="base64">
      <Output TaskParameter="Items" ItemName="_ServiceWorkerAssetsManifestItemWithHash" />
    </GetFileHash>
  </Target>

  <!--
    Compute a default ServiceWorkerAssetsManifestVersion value by combining all the asset hashes.
    This is useful because then clients will only have to repopulate caches if the contents have changed.
  -->
  <Target Name="_ComputeDefaultServiceWorkerAssetsManifestVersion">
    <PropertyGroup>
      <_CombinedHashIntermediatePath>$(_BlazorIntermediateOutputPath)serviceworkerhashes.txt</_CombinedHashIntermediatePath>
    </PropertyGroup>

    <WriteLinesToFile
      File="$(_CombinedHashIntermediatePath)"
      Lines="@(_ServiceWorkerAssetsManifestItemWithHash->'%(FileHash)')"
      WriteOnlyWhenDifferent="true"
      Overwrite="true" />

    <GetFileHash Files="$(_CombinedHashIntermediatePath)" Algorithm="SHA256" HashEncoding="base64">
      <Output TaskParameter="Items" ItemName="_ServiceWorkerAssetsManifestCombinedHash" />
    </GetFileHash>

    <PropertyGroup>
      <ServiceWorkerAssetsManifestVersion Condition="'$(ServiceWorkerAssetsManifestVersion)' == ''">$([System.String]::Copy('%(_ServiceWorkerAssetsManifestCombinedHash.FileHash)').Substring(0, 8))</ServiceWorkerAssetsManifestVersion>
    </PropertyGroup>
  </Target>

  <!-- Service worker files and their PublishedContent variants aren't regular content items, so remove them from @(Content) -->
  <Target Name="_RemoveServiceWorkerContentItems" BeforeTargets="AssignTargetPaths">
    <ItemGroup>
      <Content Remove="@(ServiceWorker); %(ServiceWorker.PublishedContent)" />
    </ItemGroup>
  </Target>

  <!-- Include the rewritten service worker files in the output -->
  <Target Name="_ComputeServiceWorkerOutputs"
          BeforeTargets="_ResolveBlazorOutputs"
          DependsOnTargets="_ComputeServiceWorkerOutputsPerServiceWorker">
    <ItemGroup>
      <_BlazorOutputWithTargetPath Include="@(_ServiceWorkerSource->'%(IntermediatePath)')" TargetOutputPath="%(_ServiceWorkerSource.TargetPath)" />
    </ItemGroup>
  </Target>

  <Target Name="_ComputeServiceWorkerOutputsPerServiceWorker"
          Inputs="@(ServiceWorker)"
          Outputs="%(Identity).nonexistent">
    <!-- If there is a PublishedContent variant, prepare to use that. If not, use the identity. -->
    <PropertyGroup>
      <_ServiceWorkerIdentity>%(ServiceWorker.Identity)</_ServiceWorkerIdentity>
      <_ServiceWorkerContentSourcePath Condition="'%(ServiceWorker.PublishedContent)' != ''">%(ServiceWorker.PublishedContent)</_ServiceWorkerContentSourcePath>
      <_ServiceWorkerContentSourcePath Condition="'%(ServiceWorker.PublishedContent)' == ''">$(_ServiceWorkerIdentity)</_ServiceWorkerContentSourcePath>
    </PropertyGroup>

    <!-- Since we need to remove the wwwroot prefix, be sure it has one -->
    <Error Text="ServiceWorker items must be located within the wwwroot directory. Found '$(_ServiceWorkerIdentity)'"
           Condition="!$([System.String]::Copy('$(_ServiceWorkerIdentity)').StartsWith('wwwroot\'))" />

    <ItemGroup>
      <_ServiceWorkerSource Include="$(_ServiceWorkerContentSourcePath)">
        <IntermediatePath>$(_BlazorIntermediateOutputPath)serviceworkers\$(_ServiceWorkerIdentity)</IntermediatePath>
        <TargetPath>$([System.String]::Copy('$(_ServiceWorkerIdentity)').Substring(8))</TargetPath>
      </_ServiceWorkerSource>
    </ItemGroup>
  </Target>

  <Target Name="_ResolveServiceWorkerOutputs"
          AfterTargets="_ComputeDefaultServiceWorkerAssetsManifestVersion"
          DependsOnTargets="_GenerateIntermediateFilePerServiceWorker">
  </Target>

  <Target Name="_GenerateIntermediateFilePerServiceWorker"
          Inputs="@(_ServiceWorkerSource); $(_CombinedHashIntermediatePath)"
          Outputs="%(IntermediatePath)">
    <!-- This should never happen. It's to diagnose ordering errors only. -->
    <Error Text="Internal error: ServiceWorkerAssetsManifestVersion was not populated" Condition="'$(ServiceWorkerAssetsManifestVersion)' == ''" />

    <Copy SourceFiles="@(_ServiceWorkerSource)" DestinationFiles="%(IntermediatePath)" />
    <WriteLinesToFile File="%(_ServiceWorkerSource.IntermediatePath)" Lines="/* Manifest version: $(ServiceWorkerAssetsManifestVersion) */" />

    <ItemGroup>
      <FileWrites Include="%(_ServiceWorkerSource.IntermediatePath)" />
    </ItemGroup>
  </Target>

</Project>
